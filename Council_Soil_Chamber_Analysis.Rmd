---
title: "Council_Soil_Chamber-Analysis"
output: html_document
date: "2024-12-03"
#Breaking up the figures and data analysis codes 
#time is in AK daylight time** NEE/RECO/GPP are in gC/m2/s; FCO2 and FCH4 are in gC/m2/s, flux_CO2 is in umol/m2/s; flux_CH4 is in nano mol/m2/s
output: html_document
date: "2024-11-18"
---
#see "stats_working" Rmd file for exploration of data variance, qq plots, gls/lme model testing, etc 

#Note that for comparison purposes, both instruments 
were used to measure chamber fluxes on July 18, 2018 --> remove potential measurement duplicates from this date?

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries 
```{r, include=FALSE}
rm(list= ls())

library(data.table)
library(ggplot2)
library(cowplot)
library(openair)
library(plotrix)
library(signal)
library(svMisc)
library(zoo)
library(stringr)
library(plyr)
library(viridis)
library(lubridate)
library(tidyverse)
library(gridExtra)
library(plotly)
library(RColorBrewer)
library(pracma)
library(dplyr)
library(openair)
library(nlme)
library(lme4)

Sys.setenv(TZ='UTC')
```


#Load filtered and merged df of soil chamber fluxes, moisture, temp (I upload multiples but only using df_NEE_RECO2 and df_NEE_RECO2_GPP for analysis below)
```{r}

#used transparent and opaque chambers to identify NEE and RECO, then merged back together 
df_NEE_RECO2 = fread('C:/Users/kkent/Documents/Council Data/Soil Chambers_Council/council_fulljoin_soilchamber_fluxes_moisttemp_2017to2019.csv')

#calculated GPP (NEE - Reco)
df_NEE_RECO2_GPP = fread('C:/Users/kkent/Documents/Council Data/Soil Chambers_Council/council_NEE_RECO2_GPP_2017to2019.csv')

# head(df_NEE_RECO2_GPP)
# str(df_NEE_RECO2_GPP)

```

#Kyle recommended having units be umol, so convert from gC/m2/s to umolC/m2/s
```{r}
# #umol to g
# # Net CO2 Flux - convert from umol/m2/s to gC/m2/s
#  flux_CO2 * (1/1000000) * 12))
# 
# 
# #Net CH4 flux --> convert from nmol/m2/s to gC/m2/s
#  flux_CH4 * (1/1000000000)*12))

#flux-CO2 and flux-CH4 are in this df and are already in umol so below is not necessary but leaving for reference
#FCH4 and FCO2 are in g/m2/s 

#g to umol 
# Net CO2 Flux - convert from umol/m2/s to gC/m2/s
# df_NEE_RECO2_GPP <- df_NEE_RECO2_GPP%>%
#   mutate(FCO2 = ifelse(is.na(flux_CO2), 0, flux_CO2 * 1/12 * 1000000)) 
# 
# 
# #Net CH4 flux --> convert from nmol/m2/s to gC/m2/s
# df_NEE_RECO2_GPP < - df_NEE_RECO2_GPP %>%
#   mutate(FCH4 = ifelse(is.na(flux_CH4), 0, flux_CH4 * 1/12 * 1000000000)*12))
```


#Re-shape df 
```{r}
library(tidyr)

#Remove the NAs from inundation 
library(dplyr)
df_NEE_RECO2_GPP<- df_NEE_RECO2_GPP %>%
   filter(!is.na(inundated))


# Reshape the dataframe to long format
df_long <- df_NEE_RECO2_GPP %>%
  select(plot_ID, plot_type, landscape_position, measurement_date, time, FCH4, flux_CO2, flux_CH4, NEE, RECO, GPP, inundated, soil_temp_10_cm, soil_temp_15_cm, thawdepth, VWC) %>%
  pivot_longer(cols = c(NEE, RECO, GPP), 
               names_to = "flux_type", 
               values_to = "flux_value")

# head(df_long)
# str(df_long)

```


#Filter df by landscape position and flux type (GPP, NEE, RECO)

####Create new df for each plot type for analysis 
```{r}
# library(dplyr)

#Filter the dataframe for plot_ID = "EC" "MW" and "BGC", and by flux type to create df for diff analysis options

#EC - eddy covar tower plot types 
df_EC <- df_NEE_RECO2_GPP %>%
  filter(plot_type == "EC")


#MW - moisture warming plot types 
df_MW <- df_NEE_RECO2_GPP %>%
  filter(plot_type == "MW")

#BGC - biogeochem plot types 
df_BGC <- df_NEE_RECO2_GPP %>%
  filter(plot_type == "BGC")

#GPP
df_GPP <-df_long %>%
  filter(flux_type == "GPP")

#NEE
df_NEE <-df_long %>%
  filter(flux_type == "NEE")
#RECO
df_RECO <-df_long %>%
  filter(flux_type == "RECO")


#Reshape the dataframe to long format and choose variables of interest 

#EC
df_EClong <- df_EC %>%
  #select(plot_ID, plot_type, landscape_position, measurement_date, NEE, RECO, GPP) %>% *choosing variables of interest 
  select(plot_ID, plot_type, landscape_position, measurement_date, FCH4, NEE, RECO, GPP, inundated, soil_temp_10_cm, soil_temp_15_cm) %>% #choosing all variables or just subset from the d_long data 
  pivot_longer(cols = c(NEE, RECO, GPP), 
               names_to = "flux_type", 
               values_to = "flux_value")

#MW
df_MWlong <- df_MW %>%
  #select(plot_ID, plot_type, landscape_position, measurement_date, NEE, RECO, GPP) %>%
   select(plot_ID, plot_type, landscape_position, measurement_date, FCH4, NEE, RECO, GPP, inundated, soil_temp_10_cm, soil_temp_15_cm) %>% #choosing all variables or just subset from the d_long data 
  pivot_longer(cols = c(NEE, RECO, GPP), 
               names_to = "flux_type", 
               values_to = "flux_value")

#BGC
df_BGClong <- df_BGC %>%
  #select(plot_ID, plot_type, landscape_position, measurement_date, NEE, RECO, GPP) %>%
   select(plot_ID, plot_type, landscape_position, measurement_date, FCH4, NEE, RECO, GPP, inundated, soil_temp_10_cm, soil_temp_15_cm) %>% #choosing all variables or just subset from the d_long data 
  pivot_longer(cols = c(NEE, RECO, GPP), 
               names_to = "flux_type", 
               values_to = "flux_value")


#Re-arrange by flux type (NEE, GPP, RECO) so you can analyze more easily 

# Sort the dataframe by the flux_type column 
df_EClong <- df_EClong %>% arrange(flux_type)
df_MWlong <- df_MWlong %>% arrange(flux_type)
df_BGClong <- df_BGClong %>% arrange(flux_type)

str(df_EClong)

```


#Note: tested models with and without random effect and there was no sig diff in GPP or NEE, though a slight improvement in RECO (p=0.02,but AIC/BIC nearly the same, so sticking with no random effect for consistency)

#NEE stats 
```{r}
#NEE stats overall 

#Tried with both 'ML' and 'REML' - no major diffs in results 
library(nlme)
#gls - no random effect
gls.NEE = gls(flux_value ~ plot_type + landscape_position + inundated + soil_temp_10_cm, data = df_NEE, method = 'ML', na.action=na.exclude)
anova(gls.NEE)
#this shows no sig diff in flux type among these 



#NEE stats within plot type 

#EC
gls.EC.NEE = gls(flux_value ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_EClong %>% filter(flux_type == "NEE"),
                 method = 'REML', na.action=na.exclude)
anova(gls.EC.NEE) #landscape position is sig, p = 0.01

library(emmeans)
gls.EC.NEE2 = gls(flux_value ~ landscape_position, 
                 data = df_EClong %>% filter(flux_type == "NEE"),
                 method = 'REML', na.action=na.exclude)
anova(gls.EC.NEE2)

emmeans(gls.EC.NEE2, adjust = "Tukey", pairwise ~ landscape_position) #p=0.015, sig ** 

#MW 
gls.MW.NEE = gls(flux_value ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_MWlong %>% filter(flux_type == "NEE"),
                 method = 'REML', na.action=na.exclude)
anova(gls.MW.NEE) #is singular so running each variable individually below 

gls.MW.NEE2 = gls(flux_value ~ soil_temp_10_cm, 
                 data = df_MWlong %>% filter(flux_type == "NEE"),
                 method = 'ML', na.action=na.exclude)
anova(gls.MW.NEE2) 
#landscape position p=0.4, no sig diff 
#inundated p=0.4, no sig diff 
#soil temp sig, p = 0.02 *** 


#BGC
gls.BGC.NEE = gls(flux_value ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_BGClong %>% filter(flux_type == "NEE"),
                 method = 'ML', na.action=na.exclude)
anova(gls.BGC.NEE) #no significant differences 



#NEE stats by landscape position 
gls.landpos.NEE = gls(flux_value ~ landscape_position, 
                 data = df_NEE ,
                 method = 'REML', na.action=na.exclude)
anova(gls.landpos.NEE) #p=0.1, not sig 


#NEE stats by inundated 
gls.inun.NEE = gls(flux_value ~ inundated, 
                 data = df_NEE ,
                 method = 'REML', na.action=na.exclude)
anova(gls.inun.NEE) #p=0.3, not sig 

#NEE stats by soil temp at 10cm
gls.temp.NEE = gls(flux_value ~ soil_temp_10_cm, 
                 data = df_NEE ,
                 method = 'REML', na.action=na.exclude)
anova(gls.temp.NEE) #p=0.28, not sig 


#NEE stats by soil plot type 
gls.plot.NEE = gls(flux_value ~ plot_type, 
                 data = df_NEE ,
                 method = 'REML', na.action=na.exclude)
anova(gls.plot.NEE) 
```
#GPP stats 
```{r}
#GPP stats overall 

#Tried with both 'ML' and 'REML' - no major diffs in results 
library(nlme)
#gls - no random effect
gls.GPP = gls(flux_value ~ plot_type + landscape_position + inundated + soil_temp_10_cm, data = df_GPP, method = 'ML', na.action=na.exclude)
anova(gls.GPP)
#sig diff in soil temp, p - 0.04 



#GPP stats within plot type 

#EC
gls.EC.GPP = gls(flux_value ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_EClong %>% filter(flux_type == "GPP"),
                 method = 'REML', na.action=na.exclude)
anova(gls.EC.GPP) #landscape position is sig, p = 0.03


library(emmeans)
gls.EC.GPP2 = gls(flux_value ~ landscape_position, 
                 data = df_EClong %>% filter(flux_type == "GPP"),
                 method = 'REML', na.action=na.exclude)
anova(gls.EC.GPP2)
emmeans(gls.EC.GPP2, adjust = "Tukey", pairwise ~ landscape_position) #p=0.033, sig 

#MW 
gls.MW.GPP = gls(flux_value ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_MWlong %>% filter(flux_type == "GPP"),
                 method = 'REML', na.action=na.exclude)
anova(gls.MW.GPP) #is singular so running each variable individually below 

gls.MW.GPP2 = gls(flux_value ~ landscape_position, 
                 data = df_MWlong %>% filter(flux_type == "GPP"),
                 method = 'REML', na.action=na.exclude)
anova(gls.MW.GPP2) 
#landscape position p=0.8, no sig diff 
#inundated p=0.7, no sig diff 
#soil temp sig, p = 0.9, no sig diff


#BGC
gls.BGC.GPP = gls(flux_value ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_BGClong %>% filter(flux_type == "GPP"),
                 method = 'REML', na.action=na.exclude)
anova(gls.BGC.GPP) #soil temp p = 0.03



#GPP stats by landscape position 
gls.landpos.GPP = gls(flux_value ~ landscape_position, 
                 data = df_GPP ,
                 method = 'REML', na.action=na.exclude)
anova(gls.landpos.GPP) #p=0.27, not sig 


#GPP stats by inundated 
gls.inun.GPP = gls(flux_value ~ inundated, 
                 data = df_GPP ,
                 method = 'REML', na.action=na.exclude)
anova(gls.inun.GPP) #p=0.65, not sig 

#GPP stats by soil temp at 10cm
gls.temp.GPP = gls(flux_value ~ soil_temp_10_cm, 
                 data = df_GPP ,
                 method = 'REML', na.action=na.exclude)
anova(gls.temp.GPP) #p=0.0529 -> not sig, borderline 

#NEE stats by plot type 
gls.plot.GPP = gls(flux_value ~ plot_type, 
                 data = df_GPP ,
                 method = 'REML', na.action=na.exclude)
anova(gls.plot.GPP) #p=0.26, not sig 

```
#RECO stats 
```{r}
#RECO stats overall 

#Tried with both 'ML' and 'REML' - no major diffs in results 
library(nlme)
#gls - no random effect
gls.RECO = gls(flux_value ~ plot_type + landscape_position + inundated + soil_temp_10_cm, data = df_RECO, method = 'ML', na.action=na.exclude)
anova(gls.RECO)
#sig diff in soil temp, p - 0.04 



#RECO stats within plot type 

#EC
gls.EC.RECO = gls(flux_value ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_EClong %>% filter(flux_type == "RECO"),
                 method = 'REML', na.action=na.exclude)
anova(gls.EC.RECO) #soil temp p=0.04


#MW 
gls.MW.RECO = gls(flux_value ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_MWlong %>% filter(flux_type == "RECO"),
                 method = 'REML', na.action=na.exclude)
anova(gls.MW.RECO) #is singular so running each variable individually below 

gls.MW.RECO2 = gls(flux_value ~ inundated, 
                 data = df_MWlong %>% filter(flux_type == "RECO"),
                 method = 'REML', na.action=na.exclude)
anova(gls.MW.RECO2) 
#landscape position p=0.4, no sig diff 
#inundated p=0.4, no sig diff 
#soil temp sig, p = 0.4, no sig diff


#BGC
gls.BGC.RECO = gls(flux_value ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_BGClong %>% filter(flux_type == "RECO"),
                 method = 'REML', na.action=na.exclude)
anova(gls.BGC.RECO) #soil temp p <0.001, sig * 



#RECO stats by landscape position 
gls.landpos.RECO = gls(flux_value ~ landscape_position, 
                 data = df_RECO ,
                 method = 'REML', na.action=na.exclude)
anova(gls.landpos.RECO) #p=0.8, not sig 


#RECO stats by inundated 
gls.inun.RECO = gls(flux_value ~ inundated, 
                 data = df_RECO ,
                 method = 'REML', na.action=na.exclude)
anova(gls.inun.RECO) #p=0.5, not sig 

#RECO stats by soil temp at 10cm
gls.temp.RECO = gls(flux_value ~ soil_temp_10_cm, 
                 data = df_RECO ,
                 method = 'REML', na.action=na.exclude)
anova(gls.temp.RECO) #p<0.001, sig * 

#NEE stats by plot type 
gls.plot.RECO = gls(flux_value ~ plot_type, 
                 data = df_RECO ,
                 method = 'REML', na.action=na.exclude)
anova(gls.plot.RECO) #p=0.5, not sig 

```
#Need to test variance structures for methane before continuing with soil chamber methane stats*** 

#FCH4 stats 
#checking data normality and homog of var 
```{r}

# Reshape the dataframe to long format
df_FCH4 <- df_long%>%
  select(plot_ID, plot_type, landscape_position, measurement_date, time, thawdepth, VWC, FCH4, flux_CH4, inundated, soil_temp_10_cm)



# Test normality within each landscape position
df_FCH4 %>%
  group_by(landscape_position) %>%
  summarize(
    shapiro_p = shapiro.test(FCH4)$p.value,
    normal = ifelse(shapiro_p > 0.05, "Yes", "No")
      )
#Results: all no 


# Test normality based on inundated
df_FCH4 %>%
  group_by(inundated) %>%
  summarize(
    shapiro_p = shapiro.test(FCH4)$p.value,
    normal = ifelse(shapiro_p > 0.05, "Yes", "No")
      )
#Results: N = no; Y = no 


# Q-Q plot of full dataset 
qqnorm(df_FCH4$FCH4)
qqline(df_FCH4$FCH4, col = "red")


#histograms with density curves by landscape position
ggplot(df_FCH4, aes(x = FCH4, fill = landscape_position)) +
  geom_histogram(aes(y = ..density..), alpha = 0.5, position = "identity", bins = 30) +
  geom_density(alpha = 0.2) +
  facet_wrap(~landscape_position) +
  theme_minimal() +
  labs(title = "Distribution of FCH4 by Landscape Position")


# histograms with density curves by inundated
ggplot(df_FCH4, aes(x = FCH4, fill = inundated)) +
  geom_histogram(aes(y = ..density..), alpha = 0.5, position = "identity", bins = 30) +
  geom_density(alpha = 0.2) +
  facet_wrap(~inundated) +
  theme_minimal() +
  labs(title = "Distribution of FCH4 by Inundation")



#homogeneity of variance - levene's test
# p > 0.05: Variances are homogeneous (no significant difference between variances).
# p ≤ 0.05: Variances are not homogeneous.
library(car)

# Test homogeneity of variance for all main factors
leveneTest(FCH4 ~ landscape_position, data = df_FCH4) #p=0.005, NOT homog of var
leveneTest(FCH4 ~ inundated, data = df_FCH4)#p = 0,001, NOT homog of var


#for interactions
leveneTest(FCH4 ~ landscape_position * inundated, data = df_FCH4) #p<0.001, not ok*


#test distribution normality of each numeric predictor variable 
shapiro.test(df_FCH4$soil_temp_10_cm) #p=0.004, NOT normal** 
shapiro.test(df_FCH4$thawdepth) #p = <0.001, NOT normal **
shapiro.test(df_FCH4$VWC) #p<0.001, NOT normal **
```
#Checking colinearity / correlations to determine which variables to use for models 

#Non-parametric tests of correlations - spearman's correlation 

#Corr of continuous variables 
```{r}
#Correlation between soil temp, thaw depth, and VWC

cor.test(df_FCH4$soil_temp_10_cm, df_FCH4$thawdepth, method="spearman")#p=0.01, *SIG*, correlated
cor.test(df_FCH4$soil_temp_10_cm, df_FCH4$VWC, method="spearman") #p<0.01, *Sig*, correlated, one should be removed 
cor.test(df_FCH4$thawdepth, df_FCH4$VWC, method="spearman") #p<0.001, *sig*, correlated, one should be removed 

#Shows thawdepth and VWC are correlated, and VWC & soil temp are correlated 
```

#Checking correlation in categorical variables 
```{r}
# Check for separation in categorical variables
table(df_FCH4$landscape_position, df_FCH4$inundated) 


# Create contingency table to examine correlation quantitatively / confirm the separation test above 
cont_table <- table(df_FCH4$landscape_position, df_FCH4$inundated)
print(cont_table)

# Test for association
chisq.test(cont_table) #p<0.001--> correlated
# Or for small sample sizes
fisher.test(cont_table) #p=0.001, correlated 

#landpos and inun are correlated, will remove inun 


```


#**Need to run through the steps for methane, but jumping to robust regression to see 

#Robust Regression - less sensitive to violations of normality but cannot incorporate variance structure**
```{r}
library(MASS)
library(car)
#just testing reduced and full models - cross-validating 

robust_model.final <- rlm(FCH4 ~ landscape_position + soil_temp_10_cm, 
                    data = df_FCH4)
summary(robust_model.final) 
Anova(robust_model.final, type = "II") #landpos p<0.001, SIG, and soil temp p <0.001 0.02, 


robust_model1 <- rlm(FCH4 ~ landscape_position + VWC, 
                    data = df_FCH4)
summary(robust_model1) 
Anova(robust_model1, type = "II") #landpos and VWC p<0.001 *SIG*


robust_model2 <- rlm(FCH4 ~ landscape_position + soil_temp_10_cm + VWC, 
                    data = df_FCH4)
summary(robust_model2) 
Anova(robust_model2, type = "II") #all variables sig 


robust_model3 <- rlm(FCH4 ~ landscape_position + VWC + soil_temp_10_cm + thawdepth,
                    data = df_FCH4)
summary(robust_model3) 
Anova(robust_model3, type = "II") #soil temp, thawdepth, and vwc sig p<0.001, landpos not sig 


```

#Attempting to test robust regression models - coding help from Claude 
```{r}
# Define a function to calculate AIC for robust regression
rlm_AIC <- function(model) {
  n <- length(model$residuals)
  RSS <- sum(model$residuals^2)
  k <- length(coef(model)) + 1  # +1 for the error variance
  AIC <- n * log(RSS/n) + 2*k
  return(AIC)
}

# Compare models
rlm_AIC(robust_model.final)
rlm_AIC(robust_model1)
rlm_AIC(robust_model2)
rlm_AIC(robust_model3)

#Results:
# [1] -14153.53 --> best model with just soil temp
# [1] -12810.24
# [1] -12815.21
# [1] -12855.44
```















```{r}
#FCH4 stats overall 

#Tried with both 'ML' and 'REML' - no major diffs in results 
library(nlme)
#gls - no random effect
gls.FCH4 = gls(FCH4 ~ plot_type + landscape_position + inundated + soil_temp_10_cm, data = df_NEE_RECO2_GPP, method = 'ML', na.action=na.exclude)
anova(gls.FCH4)
#sig diff in soil temp, p=0.02, and in inundated (p<0.001) **

# Extract standardized/normalized residuals
std_resid <- residuals(gls.FCH4, type = "normalized")

# Graphical assessment
par(mfrow = c(1, 2))
# Histogram of residuals
hist(std_resid, main = "Histogram of Standardized Residuals", 
     xlab = "Standardized Residuals", freq = FALSE)
curve(dnorm, add = TRUE, col = "red")

# QQ plot
qqnorm(std_resid, main = "Normal Q-Q Plot")
qqline(std_resid, col = "red")

# Formal test
shapiro_test <- shapiro.test(std_resid)
print(shapiro_test) #for gls final model: p<0.001; normality NOT supported 

#FCH4 stats within plot type 

#EC
gls.EC.FCH4 = gls(FCH4 ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_EClong,
                 method = 'REML', na.action=na.exclude)
anova(gls.EC.FCH4) #land pos p <0.001, inundated p = 0.002 - sig ** 

gls.EC.FCH42 = gls(FCH4 ~ landscape_position, 
                 data = df_EClong,
                 method = 'REML', na.action=na.exclude)
anova(gls.EC.FCH42) 
emmeans(gls.EC.FCH42, adjust = "Tukey", pairwise ~ landscape_position) #p=0.033, sig 


#MW 
gls.MW.FCH4 = gls(FCH4 ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_MWlong,
                 method = 'REML', na.action=na.exclude)
anova(gls.MW.FCH4) #is singular so running each variable individually below 

gls.MW.FCH42 = gls(FCH4 ~ soil_temp_10_cm, 
                 data = df_MWlong,
                 method = 'REML', na.action=na.exclude)
anova(gls.MW.FCH42) 
#landscape position p<0.001, SIG *
#inundated p<0.001, SIG *
#soil temp sig, p = 0.002, SIG *


#BGC
gls.BGC.FCH4 = gls(FCH4 ~ landscape_position + inundated + soil_temp_10_cm, 
                 data = df_BGClong,
                 method = 'REML', na.action=na.exclude)
anova(gls.BGC.FCH4) #land pos p = 0.01, inun and soil temp p <0.001, SIG *


gls.BGC.FCH42 = gls(FCH4 ~ landscape_position, 
                 data = df_BGClong,
                 method = 'REML', na.action=na.exclude)
anova(gls.BGC.FCH42) #now landpos p = 0.06, so does not make the cutoff ; inundated p <0.001
emmeans(gls.BGC.FCH42, adjust = "Tukey", pairwise ~ landscape_position) #lowland vs slope p = 0.05, borderline, other postions not sig



#FCH4 stats by landscape position 
gls.landpos.FCH4 = gls(FCH4 ~ landscape_position, 
                 data = df_NEE_RECO2_GPP,
                 method = 'REML', na.action=na.exclude)
anova(gls.landpos.FCH4) #p=0.16, not sig 


#FCH4 stats by inundated 
gls.inun.FCH4 = gls(FCH4 ~ inundated, 
                 data = df_NEE_RECO2,
                 method = 'REML', na.action=na.exclude)
anova(gls.inun.FCH4) #p=0.5, not sig 

#FCH4 stats by inundated 
gls.inun.FCH42 = gls(FCH4 ~ inundated + landscape_position, 
                 data = df_NEE_RECO2,
                 method = 'REML', na.action=na.exclude)
anova(gls.inun.FCH42) #p=0.5, not sig 

#FCH4 stats by soil temp at 10cm
gls.temp.FCH4 = gls(FCH4 ~ soil_temp_10_cm, 
                 data = df_NEE_RECO2,
                 method = 'REML', na.action=na.exclude)
anova(gls.temp.FCH4) #p<0.001, sig * 

#NEE stats by plot type 
gls.plot.FCH4 = gls(FCH4 ~ plot_type, 
                data = df_NEE_RECO2,
                 method = 'REML', na.action=na.exclude)
anova(gls.plot.FCH4) #p=0.5, not sig 
emmeans(gls.plot.FCH4, adjust = "Tukey", pairwise ~ plot_type)

```

#Soil temp stats - diffs in soil temp between landscape pos, inund, and plot type 
```{r}
#soil_temp_10_cm stats overall 

#Tried with both 'ML' and 'REML' - no major diffs in results 
library(nlme)
#gls - no random effect
gls.soil_temp_10_cm = gls(soil_temp_10_cm ~ plot_type + landscape_position, data = df_NEE_RECO2_GPP, method = 'ML', na.action=na.exclude)
anova(gls.soil_temp_10_cm)#no sig diffs



#soil_temp_10_cm stats within plot type 

#EC
gls.EC.soil_temp_10_cm = gls(soil_temp_10_cm ~ landscape_position + inundated, 
                 data = df_EClong,
                 method = 'REML', na.action=na.exclude)
anova(gls.EC.soil_temp_10_cm) #no sig diff 

gls.EC.soil_temp_10_cm2 = gls(soil_temp_10_cm ~ landscape_position, 
                 data = df_EClong,
                 method = 'REML', na.action=na.exclude)
anova(gls.EC.soil_temp_10_cm2) 



#MW 
gls.MW.soil_temp_10_cm = gls(soil_temp_10_cm ~ landscape_position + inundated, 
                 data = df_MWlong,
                 method = 'REML', na.action=na.exclude)
anova(gls.MW.soil_temp_10_cm) 

gls.MW.soil_temp_10_cm2 = gls(soil_temp_10_cm ~ inundated, 
                 data = df_MWlong,
                 method = 'REML', na.action=na.exclude)
anova(gls.MW.soil_temp_10_cm2) 
#landscape position p<0.007, SIG *
#inundated p<0.007, SIG *
emmeans(gls.MW.soil_temp_10_cm2, adjust = "Tukey", pairwise ~ landscape_position) #p=0.007 btwn lowland and upland 
emmeans(gls.MW.soil_temp_10_cm2, adjust = "Tukey", pairwise ~ inundated) #p = 0.007


#BGC
gls.BGC.soil_temp_10_cm = gls(soil_temp_10_cm ~ landscape_position + inundated, 
                 data = df_BGClong,
                 method = 'REML', na.action=na.exclude)
anova(gls.BGC.soil_temp_10_cm) #land pos p = 0.2, inun =0.001 * sig 


gls.BGC.soil_temp_10_cm2 = gls(soil_temp_10_cm ~ inundated, 
                 data = df_BGClong,
                 method = 'REML', na.action=na.exclude)
anova(gls.BGC.soil_temp_10_cm2) #p<0.001
emmeans(gls.BGC.soil_temp_10_cm2, adjust = "Tukey", pairwise ~ inundated) #p=0.001 SIG* 


#soil_temp_10_cm stats by landscape position 
gls.landpos.soil_temp_10_cm = gls(soil_temp_10_cm ~ landscape_position, 
                 data = df_NEE_RECO2_GPP,
                 method = 'REML', na.action=na.exclude)
anova(gls.landpos.soil_temp_10_cm) #p=0.65, not sig 


#soil_temp_10_cm stats by inundated 
gls.inun.soil_temp_10_cm = gls(soil_temp_10_cm ~ inundated, 
                 data = df_NEE_RECO2,
                 method = 'REML', na.action=na.exclude)
anova(gls.inun.soil_temp_10_cm) #<0.001, sig * 


#NEE stats by plot type 
gls.plot.soil_temp_10_cm = gls(soil_temp_10_cm ~ plot_type, 
                data = df_NEE_RECO2,
                 method = 'REML', na.action=na.exclude)
anova(gls.plot.soil_temp_10_cm) #p=0.038, SIG *
emmeans(gls.plot.soil_temp_10_cm, adjust = "Tukey", pairwise ~ plot_type) #contrasts show *BGC-MW contrast is 0.065, so actually not sig 

```
#Figures 

```{r}
# Create the boxplot: NEE and RECO flux vs landscape position 

landscape_C_fluxes <- ggplot(df_long, aes(x = landscape_position, y = (flux_value *1/12 * 1000000), fill = flux_type)) +
  geom_boxplot() +
  labs(title = "Council Soil Chamber GPP, NEE, and Respiration by Landscape Position",
       x = "Landscape Position",
       #y = expression(Flux~Value~(gCO[2]-C~m^-2~s^-1)),
        #y = expression(Flux~Value~(*mu*molCO[2]-C/m^2/s)),
        y = expression("Flux Value (" * mu * "mol " ~ m^-2 * ~ s^-1 * ")"),
       fill = "Flux Type") +
  geom_hline(yintercept = 0) +
    scale_y_continuous(limits = c(-6, 6))+ 
                     # breaks = seq(-7, 7, 1.5)+  # Specify the tick positions you want)+
  theme_bw() +
  theme(
   axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"), # Adjust size for x-axis text
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))



# EC plot type NEE and RECO flux vs landscape position 
ggplot(df_long %>% filter(plot_type == "EC"),
       aes(x = landscape_position, y = (flux_value *1/12 * 1000000), fill = flux_type)) +
  geom_boxplot() +
  labs(title = "EC Plots: GPP, NEE, and Respiration vs Landscape Position",
       x = "Landscape Position",
        #y = expression(Flux~Value~(gCO[2]-C/m^2/s)),
         y = expression("Flux Value (" * mu * "mol " ~ m^-2 * ~ s^-1 * ")"),
       fill = "Flux Type") +
   geom_hline(yintercept = 0)+
  scale_y_continuous(limits =c(-6, 6))+
  #scale_y_continuous(limits = c(-0.0005, 0.0007))+
   # scale_y_continuous(limits = c(-0.0002, 0.0002))+ 
                       #breaks = seq(-0.00003, 0.00008, 0.000125))+  # Specify the tick positions you want)+
  theme_minimal()+ 
  theme(
   axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"), # Adjust size for x-axis text
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))
  #annotate("text", x = #, y = #, label = "Annotation Text", size = 5, color = "blue")
  

# MW plots by landscape position 
ggplot(df_long %>% filter(plot_type == "MW"),
       aes(x = landscape_position, y = (flux_value *1/12 * 1000000), fill = flux_type)) +
  geom_boxplot() +
  labs(title = "MW Plots: GPP, NEE, and RECO vs Landscape Position",
       x = "Landscape Position",
        #y = expression(Flux~Value~(gCO[2]-C/m^2/s)),
          y = expression("Flux Value (" * mu * "mol " ~ m^-2 * ~ s^-1 * ")"),
       fill = "Flux Type") +
   geom_hline(yintercept = 0)+
   scale_y_continuous(limits =c(-6, 6))+
  #scale_y_continuous(limits = c(-0.0005, 0.0007))+
  #scale_y_continuous(limits = c(-0.0002, 0.0002))+ 
  theme_minimal()+
   theme(
   axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"), # Adjust size for x-axis text
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))


# BGC plots by landscape position 
ggplot(df_long %>% filter(plot_type == "BGC"),
       aes(x = landscape_position, y = (flux_value *1/12 * 1000000), fill = flux_type)) +
  geom_boxplot() +
  labs(title = "BGC Plots: GPP, NEE, and RECO vs Landscape Position",
       x = "Landscape Position",
       #y = expression(Flux~Value~(gCO[2]-C/m^2/s)),
       y = expression("Flux Value (" * mu * "mol " ~ m^-2 * ~ s^-1 * ")"),
       fill = "Flux Type") +
   geom_hline(yintercept = 0)+
  #scale_y_continuous(limits = c(-0.0005, 0.0007))+
  scale_y_continuous(limits = c(-6, 6))+ 
  theme_minimal()+
   theme(
   axis.title.x = element_text(size = 14),  
    axis.text.x = element_text(size = 12, face = "bold"), 
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))



```
#save image to maintain dimensions 
```{r}
# ggsave(
#   filename = "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/Soil Chambers/landscape_C_fluxes.png",  # File name and extension
#   plot = landscape_C_fluxes,        # The plot to save (default is the last plot created)
#   width = 15,                 # Width in inches
#   height = 10,                # Height in inches
#   dpi = 600,                 # Resolution in dots per inch
#   units = "cm"               # Units for width and height (can be "in", "cm", or "mm")
# )
```
#methane exploratory 
```{r}
#looking at FCH4 (in g/m2/s) by landscape position and plot type - scaled 
ggplot(df_long,
       aes(x=landscape_position, y = FCH4, fill = plot_type))+
  geom_boxplot()+
  labs( title = "Methane Flux by Plot Type vs Landscape Position ",
        x = "Landscape Position",
          y = expression(FCH4~(gCH[4]-C/m^2/s)),
          fill = "Plot Type")+
  geom_hline(yintercept=0)+
  #geom_hline(yintercept = 0.007)+
  theme_minimal() +
 #scale_y_continuous(limits = c())+
                      #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
    theme(
   axis.title.x = element_text(size = 14),  
    axis.text.x = element_text(size = 12, face = "bold"), 
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))



#looking at FCH4 (in g/m2/s) by landscape position and plot type, facet wrapped 
ggplot(df_long,
       aes(x=landscape_position, y = FCH4, fill = plot_type))+
  geom_boxplot()+
  labs( title = "Methane Fluxes within Plot Type vs Landscape Position ",
        x = "Landscape Position",
          y = expression(Methane~Flux~(gCH[4]-C/m^2/s)),
          fill = "Plot Type")+
  geom_hline(yintercept=0)+
  #geom_hline(yintercept = 0.007)+
  #theme_minimal() +
  theme_bw()+
 #scale_y_continuous(limits = c(-0.000001, 0.00001))+
                      #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
    theme(
   axis.title.x = element_text(size = 14),  
    axis.text.x = element_text(size = 12, face = "bold"), 
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold")) +
   #facet_wrap(~plot_type, labeller = "label_both")
  facet_wrap(vars(plot_type), scales = "free_x")
 
# 
# summary(df_MW$FCH4)
# summary(df_EC$FCH4)


#looking at FCH4 (in g/m2/s) by inundation
#ggplot(df_long %>% filter (!is.na(inundated)), #removing NAs within a fig only 
       ggplot(df_long,
       aes(x=inundated, y = FCH4, fill = plot_type))+
  geom_boxplot()+
  labs( title = "Methane Flux vs Inundation",
        x = "Inundation",
         y = expression(FCH4~(gCH[4]-C/m^2/s)),
        fill = "plot type")+
  geom_hline(yintercept=0)+
  theme_minimal() +
    #scale_y_continuous(limits = c(-0.0005, 0.002),
                     #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
    theme(
   axis.title.x = element_text(size = 14),  
    axis.text.x = element_text(size = 12, face = "bold"), 
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))
       
       
 # Create the scatter plot for methane 
ggplot(df_long, aes(x = landscape_position, y = FCH4, 
                                      color = plot_type, shape = inundated)) +
  geom_point(size = 3, position = position_jitter(width = 0.8, height = 0)) +  # Adjust point size for better visibility
  #scale_y_continuous(#limits = c(-0.0005, 0.0007),
                     #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
  labs(x = "Landscape Position", 
         y = expression(FCH4~(gCH[4]-C/m^2/s)), 
       title = "CH4 Flux vs Landscape Position and Inundation") +
  scale_color_manual(values = c("EC" = "green", "MW" = "blue", "BGC" = "red")) +  # Adjust color palette as needed
  theme_minimal() +  # Apply minimal theme for a clean look
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 



ggplot(df_long, aes(x = landscape_position, y = FCH4, 
                    color = plot_type, shape = inundated)) +
  geom_point(size = 3, stroke = 1.2, fill = NA, 
             position = position_jitter(width = 0.8, height = 0)) +  # Ensure hollow points
  #scale_y_continuous(limits = c(-0.0005, 0.0007),
                     #labels = function(x) x / 1000) +  # Scale y-axis labels back
  labs(x = "Landscape Position", 
       y = expression(FCH4~(gCH[4]-C/m^2/s)), 
       title = "CH4 Flux vs Landscape Position and Inundation") +
  scale_color_manual(values = c("EC" = "green", "MW" = "blue", "BGC" = "red")) +  # Custom colors
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # Rotated x-axis text
  facet_wrap(~plot_type, nrow = 1)  # Split plot by 'plot_type' into 3 panels


#scatterplot facet wrap looking at land pos, plot type, and inundation 
ggplot(df_long, aes(x = landscape_position, y = FCH4, 
                    color = plot_type)) +
  geom_point(
             position = position_jitter(width = 0.8, height = 0)) +
  #scale_y_continuous(limits = c(-0.0005, 0.0007),
                     #labels = function(x) x / 1000) +
  labs(x = "Landscape Position", 
       y = expression(FCH4~(gCH[4]-C/m^2/s)), 
       title = "CH4 Flux vs Landscape Position and Inundation") +
  #scale_color_manual(values = c("EC" = "green", "MW" = "blue", "BGC" = "red")) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.spacing = unit(3, "lines")) +  # Add space between facets
  facet_wrap(~inundated, labeller = "label_both")


```

#Methane ranges are very far apart...trying to find a scale that could work for all? 
```{r}
summary(df_MW$FCH4) #min = -1.631e-08; max =  2.157e-06 
summary(df_EC$FCH4) #min = -7.843e-08; max = 6.167e-07 
summary(df_BGC$FCH4) # min = -8.372e-07; max =  1.260e-05 
summary(df_NEE_RECO2_GPP$FCH4) #min FCH4 -8.372e-07; max = 1.260e-05 
```

#Methane figs 
```{r}
# EC plot type - FCH4 vs landscape position 
ggplot(df_long %>% filter(plot_type == "EC"),
       aes(x = landscape_position, y = FCH4, fill = inundated)) +
  geom_boxplot() +
  labs(title = "EC Plots: Methane vs Landscape Position",
       x = "Landscape Position",
         y = expression(FCH4~(gCH[4]-C/m^2/s)),
       fill = "Inundated")+
   geom_hline(yintercept = 0)+
  scale_y_continuous(limits = c(-0.00005, 0.000075))+
 # scale_y_continuous(limits = c(-0.0005, 0.0007),
                     #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
  theme_minimal()+ 
  theme(
   axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"), # Adjust size for x-axis text
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))


  

# MW plots by landscape position 
ggplot(df_long %>% filter(plot_type == "MW"),
       aes(x = landscape_position, y = FCH4, fill = inundated)) +
  geom_boxplot() +
  labs(title = "MW Plots: Methane vs Landscape Position",
       x = "Landscape Position",
         y = expression(FCH4~(gCH[4]-C/m^2/s)),
       fill = "Inundated")+
   geom_hline(yintercept = 0)+
 # scale_y_continuous(labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
  theme_minimal()+ 
  theme(
   axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"), # Adjust size for x-axis text
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))


# BGC plots by landscape position --> this has a much larger range than EC or MW, so adding a different scale here 
ggplot(df_long %>% filter(plot_type == "BGC"),
       aes(x = landscape_position, y = FCH4, fill = inundated)) +
  geom_boxplot() +
  labs(title = "BGC Plots: Methane vs Landscape Position",
       x = "Landscape Position",
         y = expression(FCH4~(gCH[4]-C/m^2/s)),
       fill = "Inundated")+
   geom_hline(yintercept = 0)+
  #scale_y_continuous(limits = c(-0.0005, 0.0007),
                    # labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
  theme_minimal()+ 
  theme(
   axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"), # Adjust size for x-axis text
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))



# all plot type - FCH4 vs landscape position 
ggplot(df_long, aes(x = landscape_position, y = FCH4, fill = inundated)) +
  geom_boxplot() +
  labs(title = "EC Plots: Methane vs Landscape Position",
       x = "Landscape Position",
         y = expression("FCH4 (" * mu * "mol" ~ CH[4]-C*m^-2*s^-1),
       #y = expression("Flux Value (" * mu * "mol " ~ m^-2 * s^-1 * ")"),
       fill = "Inundated")+
   geom_hline(yintercept = 0)+
  #scale_y_continuous(limits = c(-0.00005, 0.000075))+
 # scale_y_continuous(limits = c(-0.0005, 0.0007),
                     #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
  theme_bw()+ 
  theme(
   axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"), # Adjust size for x-axis text
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))+
  facet_wrap(vars(plot_type), scales = "free_x")
```
#Methane figs with avg 

```{r}
#EC plot methane - little bit different, grouping by land pos and inundation 

ggplot(df_long %>% filter(plot_type == "EC"),
       aes(x = landscape_position, y = FCH4, fill = inundated)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +  # Adjust width for dodging the boxes
  # stat_summary(
  #   fun = mean,   # Calculate the mean
  #   geom = "point",  # Add a point at the mean
  #   shape = 5,    # Hollow diamond shape
  #   size = 3,     # Adjust size for visibility
  #   stroke = 1,
  #   color = "black",  # Color for the mean points
  #   position = position_dodge(width = 0.8),  # Dodge the diamond to align with the boxes
  #   aes(group = interaction(landscape_position, inundated))  # Group by both landscape_position and inundated
  # ) +
  labs(title = "EC Plots: Methane vs Landscape Position and Inundation",
       x = "Landscape Position",
       y = expression(FCH4~(gCH[4]-C/m^2/s)),
       fill = "Inundated")+
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-0.0000003, 0.0000025))+
                     #labels = function(x) x / 1000) +  # Scale y-axis labels back
  theme_minimal() + 
  theme(
    axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"),  # Adjust size for x-axis text
    axis.title.y = element_text(size = 14),
    axis.text.y = element_text(size = 12, face = "bold"))


#MW plot methane - little bit different, grouping by land pos and inundation
#all lowland plots were inundated, all upland plots were not 

ggplot(df_long %>% filter(plot_type == "MW"),
       aes(x = landscape_position, y = FCH4, fill = inundated)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +  # Adjust width for dodging the boxes
  # stat_summary(
  #   fun = mean,   # Calculate the mean
  #   geom = "point",  # Add a point at the mean
  #   shape = 5,    # Hollow diamond shape
  #   size = 3,     # Adjust size for visibility
  #   stroke = 1,
  #   color = "black",  # Color for the mean points
  #   position = position_dodge(width = 0.8),  # Dodge the diamond to align with the boxes
  #   aes(group = interaction(landscape_position, inundated))  # Group by both landscape_position and inundated
  # ) +
  labs(title = "MW Plots: Methane vs Landscape Position and Inundation",
       x = "Landscape Position",
       y = expression(FCH4~(gCH[4]-C/m^2/s)),
       fill = "Inundated")+
  geom_hline(yintercept = 0) +
    scale_y_continuous(limits = c(-0.0000003, 0.0000025))+
                    # labels = function(x) x / 1000) +  # Scale y-axis labels back
  theme_minimal() + 
  theme(
    axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"),  # Adjust size for x-axis text
    axis.title.y = element_text(size = 14),
    axis.text.y = element_text(size = 12, face = "bold")
  )


#BGC plot methane - little bit different, grouping by land pos and inundation 

ggplot(df_long %>% filter(plot_type == "BGC"),
       aes(x = landscape_position, y = FCH4, fill = inundated)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +  # Adjust width for dodging the boxes
  # stat_summary(
  #   fun = mean,   # Calculate the mean
  #   geom = "point",  # Add a point at the mean
  #   shape = 5,    # Hollow diamond shape
  #   size = 3,     # Adjust size for visibility
  #   stroke = 1,
  #   color = "black",  # Color for the mean points
  #   position = position_dodge(width = 0.8),  # Dodge the diamond to align with the boxes
  #   aes(group = interaction(landscape_position, inundated))  # Group by both landscape_position and inundated
  # ) +
  labs(title = "BGC Plots: Methane vs Landscape Position and Inundation",
       x = "Landscape Position",
       y = expression(FCH4~(gCH[4]-C/m^2/s)),
       fill = "Inundated")+
  geom_hline(yintercept = 0) +
   scale_y_continuous(limits = c(-0.0000003, 0.000008))+
                     #labels = function(x) x / 1000) +  # Scale y-axis labels back
  theme_minimal() + 
  theme(
    axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"),  # Adjust size for x-axis text
    axis.title.y = element_text(size = 14),
    axis.text.y = element_text(size = 12, face = "bold")
  )

#overall

ggplot(df_long,
       aes(x = landscape_position, y = FCH4, fill = plot_type)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +  # Adjust width for dodging the boxes
  # stat_summary(
  #   fun = mean,   # Calculate the mean
  #   geom = "point",  # Add a point at the mean
  #   shape = 5,    # Hollow diamond shape
  #   size = 3,     # Adjust size for visibility
  #   stroke = 1,
  #   color = "black",  # Color for the mean points
  #   position = position_dodge(width = 0.8),  # Dodge the diamond to align with the boxes
  #   aes(group = interaction(landscape_position, plot_type))  # Group by both landscape_position and plot type
  # ) +
  labs(title = "Methane vs Landscape Position and Plot Type",
       x = "Landscape Position",
       y = expression(FCH4~(gCH[4]-C/m^2/s)),
       fill = "Plot Type")+
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-0.00000005, 0.0000008))+
                     #labels = function(x) x / 1000) +  # Scale y-axis labels back
  theme_minimal() + 
  theme(
    axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"),  # Adjust size for x-axis text
    axis.title.y = element_text(size = 14),
    axis.text.y = element_text(size = 12, face = "bold"))


ggplot(data = df_MW, aes (x=landscape_position, y = FCH4)) + geom_boxplot()



# all plot type - FCH4 vs landscape position 
ggplot(df_long, aes(x = landscape_position, y = (FCH4 *1/12 * 1000000), fill = inundated)) +
  geom_boxplot() +
  labs(title = "Methane Fluxes within Plot Type vs Landscape Position and Inundation",
       x = "Landscape Position",
         #y = expression(Methane~Flux~(gCH[4]-C/m^2/s)),
        y = expression(FCH[4]~"(" * mu * "mol" ~ CH[4]-C~m^-2~s^-1),
       fill = "Inundated")+
   geom_hline(yintercept = 0)+
  #scale_y_continuous(limits = c(-0.00005, 0.000075))+
 # scale_y_continuous(limits = c(-0.0005, 0.0007),
                     #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
  theme_bw()+ 
  theme(
   axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"), # Adjust size for x-axis text
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))+
  facet_wrap(vars(plot_type), scales = "free_x")

```

#Temp relationships 
```{r}

#FCH4 and soil temp 
ggplot(df_NEE_RECO2_GPP, aes(x=soil_temp_10_cm, y = FCH4*1000)) + geom_point()

FCH4.temp <- lm(FCH4 ~ soil_temp_10_cm, data = df_NEE_RECO2_GPP)
summary(FCH4.temp) #R2 = 0.05, p = 0.002
#extract R2 and p value for slope 
r2 <- summary(FCH4.temp)$r.squared
p_value <- summary(FCH4.temp)$coefficients[2, 4]
#plot 
ggplot(df_NEE_RECO2_GPP, aes(x = soil_temp_10_cm, y = FCH4)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Add regression line
  annotate("text", x = 0, 
           y = 0, 
           label = paste("R² = ", round(r2, 2), "\n", 
                         "p = ", signif(p_value, 3)), 
           hjust = 0, size = 5) +
  labs(x = "Soil Temperature (10 cm)", y = "FCH4",
       title = "Relationship between FCH4 and Soil Temperature") +
  theme_minimal()



#NEE and soil temp 
ggplot(df_NEE, aes(x=soil_temp_10_cm, y = flux_value )) + geom_point()

NEE.temp <- lm(flux_value ~ soil_temp_10_cm, data = df_NEE)
summary(FCH4.temp) #R2 = 0.01, p = 0.2
#extract R2 and p value for slope 
r2 <- summary(NEE.temp)$r.squared
p_value <- summary(NEE.temp)$coefficients[2, 4]
#plot 
ggplot(df_NEE, aes(x = soil_temp_10_cm, y = flux_value)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Add regression line
  annotate("text", x = 0, 
           y = 0, 
           label = paste("R² = ", round(r2, 2), "\n", 
                         "p = ", signif(p_value, 3)), 
           hjust = 0, size = 5) +
  labs(x = "Soil Temperature (10 cm)", y = "NEE",
       title = "Relationship between NEE and Soil Temperature") +
  theme_minimal()




#GPP and soil temp 
ggplot(df_GPP, aes(x=soil_temp_10_cm, y = flux_value )) + geom_point()

GPP.temp <- lm(flux_value ~ soil_temp_10_cm, data = df_GPP)
summary(FCH4.temp) #R2 = 0.02, p = 0.05
#extract R2 and p value for slope 
r2 <- summary(GPP.temp)$r.squared
p_value <- summary(GPP.temp)$coefficients[2, 4]
#plot 
ggplot(df_GPP, aes(x = soil_temp_10_cm, y = flux_value)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Add regression line
  annotate("text", x = 0, 
           y = 0, 
           label = paste("R² = ", round(r2, 2), "\n", 
                         "p = ", signif(p_value, 3)), 
           hjust = 0, size = 5) +
  labs(x = "Soil Temperature (10 cm)", y = "GPP",
       title = "Relationship between GPP and Soil Temperature") +
  theme_minimal()




#RECO and soil temp 
ggplot(df_RECO, aes(x=soil_temp_10_cm, y = flux_value )) + geom_point()

RECO.temp <- lm(flux_value ~ soil_temp_10_cm, data = df_RECO)
summary(FCH4.temp) #R2 = 0.18, p = <0.001
#extract R2 and p value for slope 
r2 <- summary(RECO.temp)$r.squared
p_value <- summary(RECO.temp)$coefficients[2, 4]
#plot 
ggplot(df_RECO, aes(x = soil_temp_10_cm, y = flux_value)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Add regression line
  annotate("text", x = 0, 
           y = 0, 
           label = paste("R² = ", round(r2, 2), "\n", 
                         "p = ", signif(p_value, 3)), 
           hjust = 0, size = 5) +
  labs(x = "Soil Temperature (10 cm)", y = "RECO",
       title = "Relationship between RECO and Soil Temperature") +
  theme_minimal()

```

#AGU figs
```{r}
#looking at FCH4 (in g/m2/s) by landscape position and plot type, facet wrapped --> revert to umolCO2 and nmolCH4*
ggplot(df_long,
       aes(x=landscape_position, y = (FCH4 *1/12 * 1000000), fill = plot_type))+
  geom_boxplot()+
  labs( title = "Methane Fluxes within Plot Type vs Landscape Position ",
        x = "Landscape Position",
          #y = expression(Methane~Flux~(gCH[4]-C/m^2/s)),
       # y = expression(FCH[4]~"(" * mu * "mol" ~ CH[4]-C~/~m^-2~/~s)~")",
        y = expression(FCH[4]~(CH[4]-C~μmol~m^{-2}~s^{-1})),
          fill = "Plot Type")+
  geom_hline(yintercept=0)+
  #geom_hline(yintercept = 0.007)+
  #theme_minimal() +
  theme_bw()+
 scale_y_continuous(limits = c(-0.15,0.15), #cut out a few bit outliers here to show trend better, 0.25 looks good but still mutes trends 
  breaks = seq(-0.15, 0.15, 0.1))+
                      #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
    theme(
   axis.title.x = element_text(size = 14),  
    axis.text.x = element_text(size = 12, face = "bold"), 
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold")) +
   #facet_wrap(~plot_type, labeller = "label_both")
  facet_wrap(vars(plot_type), scales = "free_x")

ggplot(df_long,
       aes(x=landscape_position, y = (FCH4 *1/12 * 1000000), fill = plot_type))+
  geom_boxplot()+
  labs( title = "Methane Fluxes vs Landscape Position ",
        x = "Landscape Position",
          #y = expression(Methane~Flux~(gCH[4]-C/m^2/s)),
        #y = expression(FCH[4]~"(" * mu * "mol" ~ CH[4]-C~m^-2~s^-1),
         y = expression(FCH[4]~(CH[4]-C~μmol~m^{-2}~s^{-1})),
          fill = "Plot Type")+
  geom_hline(yintercept=0)+
  #geom_hline(yintercept = 0.007)+
  #theme_minimal() +
  theme_bw()+
 scale_y_continuous(limits = c(-0.15,0.15), #cut out a few bit outliers here to show trend better, 0.25 looks good but still mutes trends 
  breaks = seq(-0.15, 0.15, 0.1))+
                      #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
    theme(
   axis.title.x = element_text(size = 14),  
    axis.text.x = element_text(size = 12, face = "bold"), 
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))# +
   #facet_wrap(~plot_type, labeller = "label_both")
  facet_wrap(vars(plot_type), scales = "free_x")


# all plot type - FCH4 vs landscape position & inundation 
ggplot(df_long, aes(x = landscape_position, y = (FCH4 *1/12 * 1000000), fill = inundated)) +
  geom_boxplot() +
  labs(title = "Methane Fluxes within Plot Type vs Landscape Position and Inundation",
       x = "Landscape Position",
         #y = expression(Methane~Flux~(gCH[4]-C/m^2/s)),
        #y = expression(FCH[4]~"(" * mu * "mol" ~ CH[4]-C~m^-2~s^-1),
        y = expression(FCH[4]~(CH[4]-C~μmol~m^{-2}~s^{-1})),
       fill = "Inundated")+
   geom_hline(yintercept = 0)+
 scale_y_continuous(limits = c(-0.15,0.46), #cut out a few bit outliers here to show trend better, -0.25 and 0.5 looks good but trying others 
  breaks = seq(-0.15, 0.46, 0.15))+
                     #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
  theme_bw()+ 
  theme(
   axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"), # Adjust size for x-axis text
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))+
  facet_wrap(vars(plot_type), scales = "free_x")

# all plot type - FCH4 vs landscape position & inundation 
landscape_CH4_fluxes <- ggplot(df_long, aes(x = landscape_position, y = (FCH4 *1/12 * 1000000), fill = inundated)) +
  geom_boxplot() +
  labs(title = "Methane Fluxes vs Landscape Position and Inundation",
       x = "Landscape Position",
         #y = expression(Methane~Flux~(gCH[4]-C/m^2/s)),
       #y = expression(FCH[4]~"(" * mu * "mol" ~ CH[4]-C~m^-2~s^-1),
       y = expression(FCH[4]~(CH[4]-C~μmol~m^{-2}~s^{-1})),
       fill = "Inundated")+
   geom_hline(yintercept = 0)+
 scale_y_continuous(limits = c(-0.15,0.46), #cut out a few bit outliers here to show trend better, -0.25 and 0.5 looks good but trying others 
  breaks = seq(-0.15, 0.46, 0.15))+
                     #labels = function(x) x / 1000)+# Scale y-axis labels back since FCH4 was scaled by 1000
  theme_bw()+ 
  theme(
   axis.title.x = element_text(size = 14),  # Adjust size for x-axis label
    axis.text.x = element_text(size = 12, face = "bold"), # Adjust size for x-axis text
   axis.title.y = element_text(size = 14),
   axis.text.y = element_text(size = 12, face = "bold"))#+
  facet_wrap(vars(plot_type), scales = "free_x")
  
  # ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_budgets_CO2.png", seasonal_budgets_CO2, 
  #      width = 10, height = 7, dpi = 600)
```

#save image to maintain dimensions 
```{r}
ggsave(
  filename = "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/Soil Chambers/landscape_CH4_fluxes.png",  # File name and extension
  plot = landscape_CH4_fluxes,        # The plot to save (default is the last plot created)
  width = 15,                 # Width in inches
  height = 10,                # Height in inches
  dpi = 600,                 # Resolution in dots per inch
  units = "cm"               # Units for width and height (can be "in", "cm", or "mm")
)
```

